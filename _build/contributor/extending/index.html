

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Extending Flyte &mdash; Flyte 0.0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Contributing to Docs" href="../docs/index.html" />
    <link rel="prev" title="Flyte Specification Language" href="../language/index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Flyte
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Flyte Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/index.html">User docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../administrator/index.html">Administrator Docs</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Contributor Docs</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../components/index.html">Flyte System Components</a></li>
<li class="toctree-l2"><a class="reference internal" href="../language/index.html">Flyte Specification Language</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Extending Flyte</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#custom-tasks">Custom Tasks</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#extending-the-idl">Extending the IDL</a></li>
<li class="toctree-l4"><a class="reference internal" href="#extending-the-sdk">Extending the SDK</a></li>
<li class="toctree-l4"><a class="reference internal" href="#extending-propeller">Extending Propeller</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../docs/index.html">Contributing to Docs</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Generated Documentation from Source</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/lyft/flyteidl">Flyte Language Specification</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Flyte</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Contributor Docs</a> &raquo;</li>
        
      <li>Extending Flyte</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/contributor/extending/index.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="extending-flyte">
<span id="contributor-extending"></span><h1>Extending Flyte<a class="headerlink" href="#extending-flyte" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound" id="extendingtoc">
</div>
<div class="section" id="custom-tasks">
<h2>Custom Tasks<a class="headerlink" href="#custom-tasks" title="Permalink to this headline">¶</a></h2>
<p>Writing logic for your own task types is the most common way to extend Flyte.  In fact, Flyte ships with several extensions by default.  These are tasks like the Qubole-run Hive queries or K8s-run Spark tasks, which were critical to Lyft’s internal deployment of Flyte but aren’t part of Flyte’s core.</p>
<div class="section" id="extending-the-idl">
<h3>Extending the IDL<a class="headerlink" href="#extending-the-idl" title="Permalink to this headline">¶</a></h3>
<p>Writing your own task will likely start with adding your own IDL message, which will look something like this <a class="reference external" href="https://github.com/lyft/flyteidl/tree/v0.14.1/protos/flyteidl/plugins/sidecar.proto">protos/flyteidl/plugins/sidecar.proto</a> or <a class="reference external" href="https://github.com/lyft/flyteidl/tree/v0.14.1/protos/flyteidl/plugins/qubole.proto">protos/flyteidl/plugins/qubole.proto</a>.  Your custom task’s proto message can reference other objects like in the Qubole case, but ultimately it has to be one message class.</p>
<p>An instance of this message class will be included alongside the rest of the <code class="docutils literal notranslate"><span class="pre">TaskTemplate</span></code> (in the <code class="docutils literal notranslate"><span class="pre">custom</span></code> field) for a given task.  Your message should include all the additional information that the execution layer of Flyte will need to execute the task.  That is, you don’t need to worry about the container image, cpu/memory resources, input/output types, etc. since that is all covered in the normal task definition.  You only need to worry about the custom information for your task.  Technically, if your custom task doesn’t need any additional information whatsoever, you can skip this step.</p>
</div>
<div class="section" id="extending-the-sdk">
<h3>Extending the SDK<a class="headerlink" href="#extending-the-sdk" title="Permalink to this headline">¶</a></h3>
<p>The next step is to write a task handler on the SDK side.  That is, now that we have the definition of what your custom task will need, we need a way for users to write that task in Python, and then transform those tasks into task specifications containing that Protobuf message.  Continuing with the above examples, we can look at how the SDK bits are built for the sidecar task and the Qubole Hive task.</p>
<p>Broadly, the steps are:</p>
<ol class="arabic simple">
<li><p>Define a task type.  Concretely, this is just the string here <a class="reference external" href="https://github.com/lyft/flyteidl/tree/v0.14.1/protos/flyteidl/core/tasks.proto#L92">protos/flyteidl/core/tasks.proto#L92</a>.  As mentioned above, technically you do not need an IDL if for some reason your custom task has no additional information whatsoever.  But even in that case, you’ll need a new task type string here.  This is the key that the execution plane will reference to decide how to run your task.</p></li>
<li><p>Create a class for your custom task that wraps the base task class (<code class="docutils literal notranslate"><span class="pre">flytekit.common.tasks.sdk_runnable.SdkRunnableTask</span></code> or just <code class="docutils literal notranslate"><span class="pre">flytekit.common.tasks.task.SdkTask</span></code> if a decorator is not required).</p></li>
<li><p>Optionally, create a decorator to make it simple to define user code.</p></li>
</ol>
<div class="section" id="qubole-hive-example">
<h4>Qubole Hive Example<a class="headerlink" href="#qubole-hive-example" title="Permalink to this headline">¶</a></h4>
<p>The Hive task is slightly more complicated in that it produces a futures file, but the basic steps are the same.</p>
<ol class="arabic simple">
<li><p>First write a class that subclasses either the <code class="docutils literal notranslate"><span class="pre">SdkRunnableTask</span></code> or <code class="docutils literal notranslate"><span class="pre">SdkTask</span></code> like so <a class="reference external" href="https://github.com/lyft/flytekit/tree/master/flytekit/common/tasks/hive_task.py#L27">flytekit/common/tasks/hive_task.py#L27</a></p></li>
<li><p>Override the <a class="reference external" href="https://github.com/lyft/flytekit/tree/master/flytekit/common/tasks/hive_task.py#L179">execute method</a> to have the behavior that you want to see.  In this case, we’re running the user code, and then compiling the output of the user’s code into our futures file.
* Also, an instance of the custom Protobuf message defined in the IDL should be created (if you need it), and added here.</p></li>
<li><p>Create a decorator for your task like this <a class="reference external" href="https://github.com/lyft/flytekit/tree/master/flytekit/sdk/tasks.py#L623">flytekit/sdk/tasks.py#L623</a>.</p></li>
</ol>
<p>Ultimately, FlyteKit is a large wrapper around the Flyte IDL objects.  That is, its primary function is to translate user Python code into the Flyte component protobufs, sometimes in multiple stages like in the Hive example, that the Flyte engine and control plane can then understand.</p>
</div>
</div>
<div class="section" id="extending-propeller">
<h3>Extending Propeller<a class="headerlink" href="#extending-propeller" title="Permalink to this headline">¶</a></h3>
<p>Flyte plugins extend the Flyte execution plane with custom behavior for special tasks.  When Flyte Propeller begins to run a task, it will look at the task type that you’ve defined and invoke the appropriate plugin.  Spark tasks and Qubole Hive tasks are examples of tasks that are run by plugins.</p>
<div class="section" id="structure-of-plugins">
<h4>Structure of Plugins<a class="headerlink" href="#structure-of-plugins" title="Permalink to this headline">¶</a></h4>
<p>At a high level, a Flyte Propeller plugin is something that satisfies the <code class="docutils literal notranslate"><span class="pre">Executor</span></code> interface specified in <a class="reference external" href="https://github.com/lyft/flyteplugins/tree/v0.1.4/go/tasks/v1/types/task.go">go/tasks/v1/types/task.go</a>.  The plugin’s initialization code should register itself against the aforementioned task type string.  When Propeller comes across a task with this type, the plugin will be invoked.  Be cognizant that a plugin runs as a singleton in the engine.</p>
<p>One of the important objects to understand is the <code class="docutils literal notranslate"><span class="pre">TaskContext</span></code>.  <a class="reference external" href="https://github.com/lyft/flyteplugins/tree/v0.1.4/go/tasks/v1/types/task_context.go">This interface</a> will be an object created by Propeller, and supplied to your plugin code.  Most importantly, the <code class="docutils literal notranslate"><span class="pre">GetCustomState()</span></code> function returns a custom struct that is integral to the cycle of your task’s execution.</p>
<p>You supply the initial value of this custom struct as the output of your <code class="docutils literal notranslate"><span class="pre">StartTask</span></code> call.  On each call of the check loop thereafter, you get the version of the custom state that you returned before.  Since this is the only state that is stored in a durable store (etcd), it should be your source of truth.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Keep in mind that Flyte Propeller can restart at any time, which means your plugin can restart at any time.  This custom state is the only state that your plugin can rely on.</p>
</div>
<p>Note that this custom state is different than the custom IDL object that you previously defined.  The IDL message should be thought of as data describing the task itself whereas this customstate should be thought of as a way to keep track of state during execution of your task.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that while the <code class="docutils literal notranslate"><span class="pre">CustomState</span></code> object returned by the <code class="docutils literal notranslate"><span class="pre">GetCustomState()</span></code> function is a <code class="docutils literal notranslate"><span class="pre">map[string]interface{}</span></code>, those interface values are not directly convertible to your Golang custom state objects.  That is, they need to be first marshaled from JSON into bytes, and then unmarshaled from bytes back into your object, like so: <a class="reference external" href="https://github.com/lyft/flyteplugins/tree/v0.1.4/go/tasks/v1/qubole/qubole_work.go#L187">go/tasks/v1/qubole/qubole_work.go#L187</a>.</p>
</div>
<div class="section" id="task-initialization">
<h5>Task Initialization<a class="headerlink" href="#task-initialization" title="Permalink to this headline">¶</a></h5>
<p>The <code class="docutils literal notranslate"><span class="pre">StartTask</span></code> function is only called once and will be called with the task template containing the custom IDL struct if you chose to create one.  You are only given this task template on this one <code class="docutils literal notranslate"><span class="pre">StartTask</span></code> call, so be sure your plugin code retrieves all the information from it that’s necessary to complete the task’s execution.  For the Qubole Hive plugin for example, the queries to be run are copied from the custom IDL object into the custom state object.</p>
</div>
<div class="section" id="task-updates">
<h5>Task Updates<a class="headerlink" href="#task-updates" title="Permalink to this headline">¶</a></h5>
<p>This is the function that will be called periodically by Flyte Propeller, and is responsible for deciding how your custom task is progressing.  Note that while the task template is there in the function signature, it is not actually used and will always be nil.  This was an unfortunate optimization that had to be made to save on S3 access times.</p>
<p>Please refer to the generated documentation for a brief discussion of the other methods of the interface.</p>
</div>
<div class="section" id="background-updates">
<h5>Background Updates<a class="headerlink" href="#background-updates" title="Permalink to this headline">¶</a></h5>
<p>Often you’ll need something to monitor the progress of your execution.  To this end, some plugins (like our Qubole Hive plugin and the waitable task plugin) make use of an <a class="reference external" href="https://godoc.org/github.com/lyft/flytestdlib/utils#AutoRefreshCache">AutoRefreshCache</a>, to which you can specify a sync function.  This sync function will be periodically run on all objects in your cache.  See the cache’s documentation for more information.</p>
</div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../docs/index.html" class="btn btn-neutral float-right" title="Contributing to Docs" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../language/index.html" class="btn btn-neutral float-left" title="Flyte Specification Language" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Flyte Authors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>